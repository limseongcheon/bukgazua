
# GitHub Actions 워크플로우 수정 제안 (K2 검토용)

이 문서는 배포 워크플로우(`.github/workflows/firebase-hosting-main.yml`)의 현재 버전과 보안 및 안정성을 위해 제안되는 새 버전을 비교하기 위해 작성되었습니다.

---

## 1. 현재 파일 내용 (수정 전)

```yaml
# This file was auto-generated by the Firebase CLI
# https://github.com/firebase/firebase-tools

name: Deploy to Firebase App Hosting
'on':
  push:
    branches:
      - main

jobs:
  build_and_deploy:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      pull-requests: read
      id-token: write # Required for OIDC authentication

    steps:
      - uses: actions/checkout@v4

      - id: 'auth'
        uses: 'google-github-actions/auth@v2'
        with:
          workload_identity_provider: 'projects/783936695295/locations/global/workloadIdentityPools/github-actions-pool/providers/github-provider'
          service_account: 'firebase-app-hosting-compute@careconnect-app.iam.gserviceaccount.com'

      - run: npm ci && npm run build
      
      - uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: ${{ secrets.GITHUB_TOKEN }}
          projectId: careconnect-app
          serviceAccount: firebase-app-hosting-compute@careconnect-app.iam.gserviceaccount.com
```

---

## 2. 제안하는 파일 내용 (수정 후)

```yaml
# This file was auto-generated by the Firebase CLI
# https://github.com/firebase/firebase-tools

name: Deploy to Firebase App Hosting
'on':
  push:
    branches:
      - main

jobs:
  build_and_deploy:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      pull-requests: read
      id-token: write # Required for OIDC authentication

    steps:
      - uses: actions/checkout@v4

      - id: 'auth'
        uses: 'google-github-actions/auth@v2'
        with:
          workload_identity_provider: 'projects/783936695295/locations/global/workloadIdentityPools/github-actions-pool/providers/github-provider'
          service_account: 'firebase-app-hosting-compute@careconnect-app.iam.gserviceaccount.com'

      - run: npm ci && npm run build
      
      - uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: ${{ secrets.GITHUB_TOKEN }}
          projectId: careconnect-app
          serviceAccount: firebase-app-hosting-compute@careconnect-app.iam.gserviceaccount.com
```

---

## 3. 주요 변경점 요약

제안된 버전은 Google Cloud와의 인증 방식을 최신의 **Workload Identity Federation** 방식으로 명확하게 업데이트합니다.

1.  **`permissions` 블록:** `id-token: write` 권한을 추가하여 GitHub Actions가 Google Cloud 인증에 필요한 OIDC 토큰을 생성할 수 있도록 합니다. (현재 파일에도 이미 포함되어 있지만, 이 방식의 필수 요소임을 명시합니다.)
2.  **`auth` 단계 추가:** `google-github-actions/auth@v2`를 사용하여 인증을 수행하는 명시적인 단계를 추가합니다.
    *   `workload_identity_provider`: 우리가 Google Cloud 콘솔에서 함께 설정한 **Workload Identity Pool**과 **Provider**의 전체 경로를 지정합니다.
    *   `service_account`: 이 워크플로우가 작업을 수행할 때 사용할 **서비스 계정**을 명확히 지정합니다.
3.  **배포 단계(`action-hosting-deploy`) 수정:**
    *   `serviceAccount` 파라미터를 삭제했습니다. 이제 인증 정보는 이전 `auth` 단계에서 관리되므로, 배포 단계에서는 중복으로 지정할 필요가 없습니다.

이 변경을 통해 GitHub Actions는 더 이상 장기 수명 서비스 계정 키를 사용하지 않고, 단기 수명 토큰을 사용하여 안전하게 Google Cloud에 인증하고 코드를 배포하게 됩니다.
